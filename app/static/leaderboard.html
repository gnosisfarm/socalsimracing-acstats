<!DOCTYPE html>
<html>
<head>
<link rel="icon" type="image/x-icon" href="/static/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">

<title>SoCalSim.Racing Leaderboard</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: url("/static/scsrweb-blk.svg") no-repeat center center fixed;
    background-size: cover;
    color: #ffffff;
    padding: 20px;
}
body::before {
    content: "";
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: -1;
}

.table-container {
    overflow-x: hidden; /* prevent horizontal scroll */
}

table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 20px;
    box-shadow: 0 0 10px #000;
    table-layout: fixed;
}

th, td {
    padding: 10px;
    border: 1px solid #444;
    word-break: break-word;
}

th {
    background: #222;
    text-align: left;
}

h1 a {
    color: #fff !important;
    text-decoration: none !important;
}

select, input {
    padding: 8px;
    background: #222;
    color: #eee;
    border: 1px solid #444;
    border-radius: 4px;
}

.filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 12px 20px;
    margin-bottom: 20px;
    align-items: center;
}

.filter-bar label {
    white-space: nowrap;
}

.track-header {
    background: #333;
    font-weight: bold;
    font-size: 1.1em;
    opacity: 0;
    animation: fadeInRow 0.35s ease forwards;
}

.track-row {
    background: rgba(17,17,17,0.8);
    opacity: 0;
    animation: fadeInRow 0.35s ease forwards;
}

.track-row:hover td {
    background: #a5a3a3;
}

.fastest-lap-row {
    background: rgba(44,44,0,0.25);
    position: relative;
}

.fastest-lap-row::after {
    content: "";
    position: absolute;
    inset: -2px;
    z-index: -1;
    border-radius: 4px;
    animation: glow 2s infinite alternate;
}

@keyframes glow {
    from {
        box-shadow:
            0 0 8px rgba(255,215,0,0.5),
            0 0 15px rgba(255,215,0,0.35);
    }
    to {
        box-shadow:
            0 0 15px rgba(255,230,80,0.9),
            0 0 35px rgba(255,200,0,0.6);
    }
}

@keyframes fadeInRow {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
</head>

<body>

<h1><a href="/">SoCalSim.Racing Assetto Corsa Server</a></h1>
<h2>Fastest Laps Leaderboard</h2>

<div class="filter-bar">
    <label for="trackSelect">Track</label>
    <select id="trackSelect">
        <option value="">All Tracks</option>
    </select>

    <label for="driverFilter">Driver</label>
    <input id="driverFilter" type="text" placeholder="Filter driver">

    <label for="carFilter">Car</label>
    <input id="carFilter" type="text" placeholder="Filter car">
</div>

<div class="table-container">
<table id="trackTable">
    <thead>
        <tr>
            <th style="width:28%">Driver</th>
            <th style="width:32%">Car</th>
            <th style="width:20%">Lap Time</th>
            <th style="width:20%">Timestamp (PST)</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
</div>

<script>
function convertToPST(utcString) {
    if (!utcString) return "";
    return new Date(utcString + "Z")
        .toLocaleString("en-US", { timeZone: "America/Los_Angeles" });
}

const driverFilter = document.getElementById("driverFilter");
const carFilter = document.getElementById("carFilter");
const trackSelect = document.getElementById("trackSelect");

driverFilter.addEventListener("input", renderTable);
carFilter.addEventListener("input", renderTable);

let trackGroups = {};
let selectedTrack = "";
let isTrackView = false;

// Reverse map for tooltips: friendly name -> real IDs
let friendlyTrackMapRev = {};

// -----------------------------
// Load tracks dropdown & tooltip map
// -----------------------------
async function loadTracks() {
    const res = await fetch("/api/tracks");
    const tracks = await res.json();

    friendlyTrackMapRev = {};
    tracks.forEach(t => {
        if (!friendlyTrackMapRev[t.name]) friendlyTrackMapRev[t.name] = [];
        friendlyTrackMapRev[t.name].push(t.id);
    });

    const friendlyNames = Object.keys(friendlyTrackMapRev).sort((a,b)=> a.localeCompare(b));

    friendlyNames.forEach(fName => {
        const opt = document.createElement("option");
        opt.value = friendlyTrackMapRev[fName][0];
        opt.textContent = fName;
        trackSelect.appendChild(opt);
    });
}

// -----------------------------
// Load top lap per track (main page)
async function loadAllTracksFastest() {
    const res = await fetch("/api/top_all");
    const data = await res.json();

    trackGroups = {};
    for (const [trackId, row] of Object.entries(data)) {
        const fName = row.track_name;
        if (!trackGroups[fName]) trackGroups[fName] = [];
        trackGroups[fName].push(row);
    }

    // Keep top lap only per friendly track
    for (const fName in trackGroups) {
        trackGroups[fName] = trackGroups[fName].slice(0,1);
    }

    // Sort table by friendly name
    trackGroups = Object.fromEntries(
        Object.entries(trackGroups).sort((a,b)=> a[0].localeCompare(b[0]))
    );

    isTrackView = false;
    renderTable();
}

// -----------------------------
// Load laps for one track
async function loadTrackLaps(trackId) {
    const fName = Object.keys(friendlyTrackMapRev).find(fn => friendlyTrackMapRev[fn].includes(trackId));
    const realIds = friendlyTrackMapRev[fName] || [trackId];

    const allLaps = [];
    for (const id of realIds) {
        const res = await fetch(`/api/top/${id}`);
        const laps = await res.json();
        laps.forEach(l => allLaps.push(l));
    }

    // Merge by friendly name
    trackGroups = {};
    allLaps.forEach(l => {
        const name = l.track_name;
        if (!trackGroups[name]) trackGroups[name] = [];
        trackGroups[name].push(l);
    });

    // Sort laps fastest -> slowest
    for (const name in trackGroups) {
        trackGroups[name].sort((a,b)=>{
            const parse = s => {
                const [m, rest] = s.split(":");
                const [s2, ms] = rest.split(".");
                return parseInt(m)*60000 + parseInt(s2)*1000 + parseInt(ms);
            };
            return parse(a.laptime) - parse(b.laptime);
        });
    }

    isTrackView = true;
    renderTable();
}

// -----------------------------
// Render table with fade-in
// -----------------------------
function renderTable() {
    const tbody = document.querySelector("#trackTable tbody");
    tbody.innerHTML = "";

    const df = driverFilter.value.toLowerCase();
    const cf = carFilter.value.toLowerCase();

    let idxGlobal = 0;
    for (const trackName of Object.keys(trackGroups)) {
        const rows = trackGroups[trackName];
        if (!rows || rows.length === 0) continue;

        const hdr = document.createElement("tr");
        const th = document.createElement("th");
        th.colSpan = 4;
        th.className = "track-header";
        th.title = (friendlyTrackMapRev[trackName] || []).join(", ");
        th.style.opacity = 0;
        th.style.animationDelay = `${idxGlobal*0.04}s`;
        th.textContent = `${trackName}`;
        hdr.appendChild(th);
        tbody.appendChild(hdr);
        idxGlobal++;

        rows.forEach((r, idx) => {
            if (!isTrackView && idx > 0) return;
            if (df && !r.player.toLowerCase().includes(df)) return;
            if (cf && !r.car.toLowerCase().includes(cf)) return;

            const tr = document.createElement("tr");
            tr.className = "track-row";
            if (isTrackView && idx === 0) tr.classList.add("fastest-lap-row");
            tr.style.opacity = 0;
            tr.style.animationDelay = `${idxGlobal*0.04}s`;

            tr.innerHTML = `
                <td>${r.player}</td>
                <td>${r.car}</td>
                <td>${r.laptime}</td>
                <td>${convertToPST(r.timestamp)}</td>
            `;
            tbody.appendChild(tr);
            idxGlobal++;
        });
    }
}

// -----------------------------
// Track selector change
// -----------------------------
trackSelect.addEventListener("change", async () => {
    selectedTrack = trackSelect.value;
    if (selectedTrack) {
        await loadTrackLaps(selectedTrack);
    } else {
        await loadAllTracksFastest();
    }
});

// -----------------------------
// Init
// -----------------------------
loadTracks();
loadAllTracksFastest();
</script>

</body>
</html>
